var Article = require('../models/ArticleModel');
var Comment = require('../models/CommentModel');

module.exports = {
	add: function(req,res) { 
		res.render('articles/new.twig', {
			title: 'New Article',
			body: 'Test body',
		});
	},
	list: function(req,res) {
		/*var perPage = 2;
		var page = Math.max(0, req.param('page'));

		Article.find()
			.select('name')
			.limit(perPage)
			.skip(perPage * page)
			.sort({
				name: 'asc'
			})
			.exec(function(err, articles) {
				Article.count().exec(function(err, count) {
					console.log(articles);
					res.render('articles/index.twig', {
						title: 'List of Articles',
						articles: articles,
						page: page,
						pages: count / perPage
					})
				})
			})*/
		
		Article.find({}, function(err, articles) {
			if(err)
				console.log(err);
			else 
				res.render('articles/index.twig', {
					title: 'List of Articles',
					articles: articles
				});
		});
	},
	save: function(req,res) {
		var article = new Article(req.body.article);
		article.save(function(err) {
			if(err)
				console.log(err);
			else
				res.redirect('/articles');
		});
	},
	view: function(req,res) {
		/*Article.findOne({ _id : req.params.id }, function(err,article) {			
			if (err) console.log(err);
			if (!article) return next(new Error('Failed to load article ' + req.params.id));
			res.render('articles/show.twig', {
				article: article
			});
		});*/
		Article
			.findOne({ _id : req.params.id })
			.populate('comments') // only works if we pushed refs to children
			.exec(function (err, article) {
				if (err) console.log(err);
				if (!article) return next(new Error('Failed to load article ' + req.params.id));
				res.render('articles/show.twig', {
					article: article
				});
				//console.log(article);
			})
			
		// Working for getting Article	
		/*Comment
			.findOne({ _id : '59265d2611e84905bceea79c' })
			.populate('article')
			.exec(function (err, cmt) {
			if (err) return handleError(err);
			console.log('The creator is %s', cmt.article.title);
		});*/
	},
	saveComment: function(req,res) {
		Article.findOne({ _id : req.body.article._id }, function(err,article) {			
			if (err) console.log(err);
			if (article) {
				if (req.body.article.comment && req.body.article.comment.body) {
					var comment = new Comment({
						fullname : req.body.article.comment.fullname,
						article_id : req.body.article._id,
						body : req.body.article.comment.body
					});
					article.comments.push(comment);
					req.flash('notice', 'Comment added successfully');
				}
				article.save(function(err, doc) {
				  if (err) throw err;
				  if (comment) {
						comment.save(function(err){
							if (err) throw err;
						});
					}
				});
			}	
		});		
		res.redirect('/articles');
	},
	edit: function(req,res) {
		Article.findOne({ _id : req.params.id }, function(err,article) {
			if (err) console.log(err);
			if (!article) return next(new Error('Failed to load article ' + req.params.id));
			res.render('articles/edit.twig', {
				article: article
			});
		});
	},
	update: function(req,res) {
		objectId = req.body.article._id;
		if(objectId != '') {
			Article.findOneAndUpdate({_id: objectId }, req.body.article, function(err) {
				if(err)
					console.log(err);
				else
					res.redirect('/articles');
			});
		}
	},
	delete: function(req,res) {		
		if(req.params.id != '') {
			Article.findByIdAndRemove({_id: req.params.id }, function(err) {
				if(err) {
					console.log(err);
					req.flash('error', 'Deletion Problem');
				} else {
					console.log('Article Removed');
					req.flash('info', 'Deleted successfully');
				}
				res.redirect('/articles');		
			});
		} else {
			res.redirect('/articles');
		}
	}
}